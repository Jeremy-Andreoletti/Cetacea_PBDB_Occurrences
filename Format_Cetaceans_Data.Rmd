---
title: "Format Cetaceans Data"
output:
  pdf_document: 
    fig_height: 5.5
    fig_width: 10
    toc: yes
  html_notebook:
    code_folding: hide
  html_document:
    fig_width: 10
    toc: yes
---

Creation - jeremy.andreoletti@ens.fr - 13/04/2020

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library("ggplot2")
library("dplyr")
library("ggtree")
```

```{r}
setwd("~/Documents/Scolaire/ENS/Stage_M1/Cetaceans/")
```

# Load occurrence dataset

```{r}
# cetacea_pbdb <- read.csv("data-cetaceans/cetacea_pbdb_05_Apr_2018.csv", skip = 16)
cetacea_pbdb <- read.csv2("data-cetaceans/cetacea_pbdb_11_May_2020.csv", skip = 17)
# Remove columns with only NAs
cetacea_pbdb <- cetacea_pbdb[,colSums(is.na(cetacea_pbdb)) < nrow(cetacea_pbdb)]
# Record classying numbers as factors
cetacea_pbdb[, grep("_no", names(cetacea_pbdb), value = T)] <- data.frame(sapply(cetacea_pbdb[, grep("_no", names(cetacea_pbdb), value = T)], as.factor))
# Record numeric quantities as doubles
cetacea_pbdb[, c("lat", "lng", "paleolat", "paleolng", "min_ma", "max_ma")] <- sapply(cetacea_pbdb[, c("lat", "lng", "paleolat", "paleolng", "min_ma", "max_ma")], function(col){as.numeric(as.character(col))})
summary(cetacea_pbdb[grep("comment", names(cetacea_pbdb), value = T, invert=T)])
```

```{r}
head(cetacea_pbdb, 10)
```

Reorder accepted ranks according to classification standard.

```{r}
levels(cetacea_pbdb$accepted_rank)
cetacea_pbdb$accepted_rank <- factor(cetacea_pbdb$accepted_rank, levels=c("subspecies", "species", "genus", "subfamily", "family", "superfamily", "infraorder", "suborder", "order", "unranked clade"))
cetacea_pbdb$identified_rank <- factor(cetacea_pbdb$identified_rank, levels=c("subspecies", "species", "genus", "subfamily", "family", "superfamily", "infraorder", "suborder", "order", "unranked clade"))
```

# Load the list of occurrences with morphological information

```{r}
occurrences_with_morphology <- read.csv2("data-cetaceans/SpecimensPBDB_newNames.csv")
summary(occurrences_with_morphology)
```

Combine those taxa with extant taxa to get all the species included in the tree.

```{r}
extant_taxa <- read.csv2("data-cetaceans/Cetacea_extant_taxa.csv")
summary(extant_taxa)
```

```{r}
extinct_taxa <- cetacea_pbdb[cetacea_pbdb$occurrence_no %in% occurrences_with_morphology$pbdb_occurence.number, c("accepted_name", "min_ma", "max_ma")]
extinct_taxa$accepted_name <- as.factor(gsub(" ", "_", extinct_taxa$accepted_name))
names(extinct_taxa) <- names(extant_taxa)
summary(extinct_taxa)
```

```{r}
taxa <- rbind(extant_taxa, extinct_taxa)
summary(taxa)
write.table(taxa, file = "data-cetaceans/Cetacea_taxa.csv", quote = F, sep="\t", row.names = F)
```

Check that the names in the datasets are exactly the same as in the list above.

```{r}
morpho_names <- read.table("data-cetaceans/morpho_simplified_newNames_removeOutgroupsUndescribed.nex", skip=6, fill=T)
morpho_names <- droplevels(morpho_names$V1[sapply(morpho_names$V1, grepl, pattern="_")])

mit_names <- read.table("data-cetaceans/M4376_mt_simplified_newNames_removeOutgroups.nex", skip=6, fill=T)
mit_names <- droplevels(mit_names$V1[sapply(mit_names$V1, grepl, pattern="_")])

nuc_names <- read.table("data-cetaceans/M4358_nuclear_simplified_newNames_removeOutgroups.nex", skip=6, fill=T)
nuc_names <- droplevels(nuc_names$V1[sapply(nuc_names$V1, grepl, pattern="_")])

setequal(taxa$taxon, union(union(morpho_names, mit_names), nuc_names))
```

Idem at the generic level for the genus analysis.

```{r}
occurrences_with_morphology_genera <- occurrences_with_morphology[-which(occurrences_with_morphology$Taxon %in% c("Atocetus_nasalis", "Brachydelphis_jahuayensis", "Haborophocoena_minutus", "Lophocetus_repenningi", "Odobenocetops_peruvianus", "Otekaikea_huata", "Parapontoporia_wilsoni")),]
extant_genera <- read.csv2("data-cetaceans/Cetacea_extant_genera.csv")
summary(extant_genera)

extinct_genera <- cetacea_pbdb[cetacea_pbdb$occurrence_no %in% occurrences_with_morphology_genera$pbdb_occurence.number, c("accepted_name", "min_ma", "max_ma")]
extinct_genera$accepted_name <- as.factor(gsub(" ", "_", extinct_genera$accepted_name))
names(extinct_genera) <- names(extant_genera)
summary(extinct_genera)

genera <- rbind(extant_genera, extinct_genera)
summary(genera)
write.table(genera, file = "data-cetaceans/Cetacea_genera.csv", quote = F, sep="\t", row.names = F)
```

Check that the names in the datasets are exactly the same as in the list above.

```{r}
morpho_names_genera <- read.table("data-cetaceans/morpho_simplified_newNames_genera_removeOutgroupsUndescribed.nex", skip=6, fill=T)
morpho_names_genera <- droplevels(morpho_names_genera$V1[sapply(morpho_names_genera$V1, grepl, pattern="_")])

mit_names_genera <- read.table("data-cetaceans/M4376_mt_simplified_newNames_genera_removeOutgroups.nex", skip=6, fill=T)
mit_names_genera <- droplevels(mit_names_genera$V1[sapply(mit_names_genera$V1, grepl, pattern="_")])

nuc_names_genera <- read.table("data-cetaceans/M4358_nuclear_simplified_newNames_genera_removeOutgroups.nex", skip=6, fill=T)
nuc_names_genera <- droplevels(nuc_names_genera$V1[sapply(nuc_names_genera$V1, grepl, pattern="_")])

setequal(genera$taxon, union(union(morpho_names_genera, mit_names_genera), nuc_names_genera))
```

Remove those occurrences from our initial dataset to avoid redundancy.

```{r}
cetacea_pbdb <- cetacea_pbdb[!(cetacea_pbdb$occurrence_no %in% occurrences_with_morphology$pbdb_occurence.number),]
```

# Explore the dataset
## Repartition through time
### Full fossil record

```{r}
# Compute the mean age in the time interval
cetacea_pbdb$age_mean <- (cetacea_pbdb$min_ma+cetacea_pbdb$max_ma)/2

ggplot(cetacea_pbdb, aes(x=-age_mean, y=rnorm(length(age_mean), 1, 0.05))) +
  geom_point(cex=0.1, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Occurrences", limits = c(0.5, 1.5)) +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  ggtitle(paste("Repartition of", dim(cetacea_pbdb)[1], "recorded occurrences through time"))

ggplot(cetacea_pbdb, aes(x=-age_mean)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Number of occurrences") +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.grid.major.y = element_blank(),
        legend.position="bottom") +
  ggtitle(paste("Evolution of the number occurrences through time ( total of", dim(cetacea_pbdb)[1], ") - Midpoint"))
```

$\to$ Numerous occurrences seem to have the same age interval so in order to avoid clusters let's draw them uniformly in their stratigraphic range rather than taking the mean.

```{r}
# Draw occurrence age uniformally in the time interval
cetacea_pbdb$age_runif <- mapply(function(m, M){runif(n=1, min=m, max=M)}, cetacea_pbdb$min_ma, cetacea_pbdb$max_ma)

ggplot(cetacea_pbdb, aes(x=-age_runif, y=rnorm(length(age_runif), 1, 0.05))) +
  geom_point(cex=0.1, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Occurrences", limits = c(0.5, 1.5)) +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  ggtitle(paste("Repartition of", dim(cetacea_pbdb)[1], "recorded occurrences through time"))

ggplot(cetacea_pbdb, aes(x=-age_runif)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Number of occurrences") +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.grid.major.y = element_blank(),
        legend.position="bottom") +
  ggtitle(paste("Evolution of the number occurrences through time ( total of", dim(cetacea_pbdb)[1], ") - Uniform draw"))
```

$\to$ The repartition seems much smoother now.

### Subsampling

These occurrences are too numerous for our current implementation, let's subsample a fraction of them for now.

```{r}
cetacea_pbdb_subsampled <- sample_n(cetacea_pbdb, size=round(length(age_runif)*0.10))

ggplot(cetacea_pbdb_subsampled, aes(x=-age_runif, y=rnorm(length(age_runif), 1, 0.05))) +
  geom_point(cex=0.5, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Occurrences", limits = c(0.5, 1.5)) +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  ggtitle(paste("Repartition of", dim(cetacea_pbdb_subsampled)[1], "recorded occurrences through time"))

ggplot(cetacea_pbdb_subsampled, aes(x=-age_runif)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Number of occurrences") +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.grid.major.y = element_blank(),
        legend.position="bottom") +
  ggtitle(paste("Evolution of the number occurrences through time ( total of", dim(cetacea_pbdb_subsampled)[1], ") - Uniform draw"))
```

$\to$ The distribution looks similar, with some noise due to higher variance with smaller sample.

```{r}
write(cetacea_pbdb$age_mean, file = "data-cetaceans/Cetacea_occurrences_mean_age.csv", sep="; ", ncolumns = dim(cetacea_pbdb)[1])
write(cetacea_pbdb$age_runif, file = "data-cetaceans/Cetacea_age_runif_age.csv", sep="; ", ncolumns = dim(cetacea_pbdb)[1])
write(cetacea_pbdb_subsampled$age_runif, file = "data-cetaceans/Cetacea_age_runif_age_subsampled.csv", sep="; ", ncolumns = dim(cetacea_pbdb_subsampled)[1])
```

## Repartition among accepted ranks
### Pie chart

```{r}
ggplot(cetacea_pbdb, aes(x=factor(record_type), fill=accepted_rank)) +
  geom_bar(width = 1, stat = "count") +
  coord_polar("y") + 
  scale_fill_discrete(name="Accepted rank") +
  labs(x = NULL, y = NULL, fill = NULL, title = "Repartition of occurrences among accepted ranks")
```

$\to$ Half of the occurrences are identified at the level of the secies and 1/3 at the genus or family.

Some clades are unranked :

```{r}
table(as.character(cetacea_pbdb[cetacea_pbdb$accepted_rank=="unranked clade",]$accepted_name))
```

### Time repartition by rank

```{r fig.height=6}
ggplot(cetacea_pbdb[cetacea_pbdb$accepted_rank %in% c("species", "genus"),], aes(x=-age_runif, fill=accepted_rank)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Number of occurrences") +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle("Evolution of the number occurrences through time (0.1 My time bins), by accepted rank") +
  facet_grid(accepted_rank ~ ., scales="free")

# Count the number of occurrences with the same accepted name
cetacea_pbdb$accepted_name_count <- sapply(cetacea_pbdb$accepted_name, function(x){table(cetacea_pbdb$accepted_name)[x]})
# Get the duration of the time intervals
cetacea_pbdb$age_range <- cetacea_pbdb$max_ma-cetacea_pbdb$min_ma

ggplot(cetacea_pbdb, aes(x=accepted_name_count/age_range, fill=factor(max_ma))) +
  geom_histogram(binwidth=0.1) +
  scale_x_continuous(trans="log10", name="Density of occurrences (number/My)") +
  scale_fill_discrete(name="Maximum age (My)") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle("Distributions occurrence density, by accepted rank") +
  facet_grid(accepted_rank ~ .)

ggplot(cetacea_pbdb, aes(x=accepted_name_count/age_range, fill=factor(round(age_range, 2)))) +
  geom_histogram(binwidth=0.1) +
  scale_x_continuous(trans="log10", name="Density of occurrences (number/My)") +
  scale_fill_discrete(name="Age range (My)") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle("Distributions occurrence density, by accepted rank") +
  facet_grid(accepted_rank ~ .)
```

$\to$ Apparent huge cluster of occurrences in recent times, with very precise dating = Artefact due to the "Pull of the Recent" effect ? $\to$ We decided to **remove all Late Pleistocene and Holocene occurrences** (thus setting the $\omega$-sampling to 0) in order to avoid this bias.

```{r}
Cetacea_occ <- cetacea_pbdb[cetacea_pbdb$age_runif > 0.126,]

data.frame(cetacea_pbdb = dim(cetacea_pbdb)[1],
           Cetacea_occ = dim(Cetacea_occ)[1],
           removed = dim(cetacea_pbdb)[1]-dim(Cetacea_occ)[1],
           row.names = "Number of occurrences")
```

```{r fig.height=6}
ggplot(Cetacea_occ[!Cetacea_occ$accepted_rank %in% c("subspecies", "infraorder"),], aes(x=-age_runif, fill=accepted_rank)) +
  geom_histogram(binwidth = 0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Number of occurrences") +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle("Evolution of the number occurrences through time (0.5 My time bins), by accepted rank") +
  facet_grid(accepted_rank ~ ., scales="free")
```

$\to$ We observe similar trends at each rank, with peaks at ~15My and ~5My.

### Redundancy of occurrences with the same accepted name

```{r fig.height=6}
ggplot(cetacea_pbdb, aes(x=reorder(accepted_name, table(accepted_name)[accepted_name]), fill=accepted_rank)) +
  geom_bar(stat="count") + 
  scale_x_discrete(name = "Accepted names") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding occurrences (log-scale)") +
  scale_fill_discrete(name="Accepted rank") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position="bottom") +
  ggtitle("Distributions of the number of occurrences with the same accepted name, by accepted rank") +
  facet_grid(. ~ accepted_rank, scales="free_x")
```

$\to$ ~Half of species/genera/subfamilies have only one specimen by accepted name, but it could go up to ~50 within the same species and ~200 occurrences within the same suborder. **Those differences will have to be corrected because in our model all species are upposed to have the same abundance (identical sampling rates among branches).**

$\implies$ Our goal now will be to correct this abundance bias.

## Time intervals = stratigraphic age uncertainty
### Minimum and maximum stratigraphic limits

```{r fig.height=4}
ggplot(cetacea_pbdb, aes(x=reorder(late_interval, -max_ma, median), group = -max_ma, fill=-max_ma)) +
  geom_bar(stat="count") + 
  scale_x_discrete(name = "Late Stratigraphic Limit") +
  scale_y_continuous(name = "Number of corresponding occurrences") +
  scale_fill_continuous(name = "Maximum Age (My)") +
  ggtitle("Distribution of maximum stratigraphic ages") +
  theme(panel.grid.major.x = element_blank(),
        legend.position="bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))

ggplot(cetacea_pbdb, aes(x=reorder(early_interval, -min_ma, median), group = -min_ma, fill=-min_ma)) +
  geom_bar(stat="count") + 
  scale_x_discrete(name = "Early Stratigraphic Limit") +
  scale_y_continuous(name = "Number of corresponding occurrences") +
  scale_fill_continuous(name = "Minimum Age (My)") +
  ggtitle("Distribution of minimum stratigraphic ages") +
  theme(panel.grid.major.x = element_blank(),
        legend.position="bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))
```

$\to$ Most species have a early but not a late stratigraphic limit.

### Minimum and maximum ages

```{r }
# Get the stratigraphic interval of time uncertainty
Cetacea_occ$age_interval <- mapply(function(min_age, max_age){paste("[",-max_age,", ",-min_age,"]", sep = "")}, Cetacea_occ$min_ma, Cetacea_occ$max_ma)

ggplot(Cetacea_occ, aes(x=-max_ma, y=age_interval)) +
  geom_segment(aes(x = -max_ma, y = reorder(age_interval, -age_mean), xend = -min_ma, yend=reorder(age_interval, -age_mean), color=-age_mean)) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Age intervals") +
  labs(colour="Mean age") +
  ggtitle("Distribution of age intervals") +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid.major.y = element_blank())
```

## Time ranges = duration of the time intervals
### Count occurrences by accepted name

```{r fig.height=8}
# Count the number of occurrences with the same accepted name
Cetacea_occ$accepted_name_count <- sapply(Cetacea_occ$accepted_name, function(x){table(Cetacea_occ$accepted_name)[x]})

my_breaks <- c(1,3,10,35,100,max(Cetacea_occ$accepted_name_count))

ggplot(Cetacea_occ[!(Cetacea_occ$accepted_rank %in% c("species", "genus", "family")),], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_ma, y = reorder(accepted_name, -age_mean), xend = -min_ma, yend=reorder(accepted_name, -age_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.3) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Accepted ranks") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank()) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil age ranges, by accepted rank") +
  facet_grid(accepted_rank ~ ., scales = "free")

ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="species",], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_ma, y = reorder(accepted_name, -age_mean), xend = -min_ma, yend=reorder(accepted_name, -age_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.3) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Age ranges") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank(),
        axis.text.y=element_text(size=2)) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil age ranges (species)") +
  facet_grid(accepted_rank ~ ., scales = "free")

ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="genus",], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_ma, y = reorder(accepted_name, -age_mean), xend = -min_ma, yend=reorder(accepted_name, -age_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.3) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Genus") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank(),
        axis.text.y=element_text(size=6)) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil age ranges (genera)") +
  facet_grid(accepted_rank ~ ., scales = "free")

ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="family",], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_ma, y = reorder(accepted_name, -age_mean), xend = -min_ma, yend=reorder(accepted_name, -age_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.3) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Genus") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank()) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil age ranges (families)") +
  facet_grid(accepted_rank ~ ., scales = "free")
```

$\to$ Some occurrences have too much age uncertainty, they risk to artificially increase species durations.

### Remove occurrences with highly uncertain dating (range > 10My)

```{r}
# Get the duration of the time intervals
Cetacea_occ$age_range <- Cetacea_occ$max_ma-Cetacea_occ$min_ma
# Occurrences whose time range is lower than 8 million years
dim(Cetacea_occ[Cetacea_occ$age_range<10,])

ggplot(Cetacea_occ, aes(x=age_range, fill=accepted_rank)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(name = "Age uncertainty range (My)") +
  scale_y_continuous(name = "Number of corresponding occurrences") +
  geom_segment(aes(x = 9.5, y = 0, xend = 9.5, yend=1050), color="black", linetype="dashed") +
  ggtitle("Distribution of occurrences' age uncertainty range")
```

Most of occurrences show less than 10 My age uncertainty, let's try to keep only these ones.

```{r}
data.frame(all_ranges = dim(Cetacea_occ)[1],
           smaller_10My = dim(Cetacea_occ[Cetacea_occ$age_range<10,])[1],
           removed = dim(Cetacea_occ)[1]-dim(Cetacea_occ[Cetacea_occ$age_range<10,])[1], row.names = "Number of occurrences")
```

```{r fig.height=6}
ggplot(Cetacea_occ, aes(x=age_runif, y=age_range)) +
  geom_point(alpha=0.05) +
  scale_x_continuous(name = "Uniformly drawn age (My)") +
  scale_y_continuous(name = "Age uncertainty range (My)") +
  ggtitle("Distribution of occurrences' age uncertainty range")

ggplot(Cetacea_occ[Cetacea_occ$age_range != 63.412,], aes(x=age_runif, y=age_range)) +
  geom_point(alpha=0.05) +
  scale_x_continuous(name = "Uniformly drawn age (My)") +
  scale_y_continuous(name = "Age uncertainty range (My)") +
  geom_segment(aes(x = 0, y = 10, xend=60, yend = 10), color="black", linetype="dashed") +
  ggtitle("Distribution of occurrences' age uncertainty range")

ggplot(Cetacea_occ[Cetacea_occ$age_range<10,], aes(x=age_runif, y=age_range)) +
  geom_point(alpha=0.05) +
  scale_x_continuous(name = "Uniformly drawn age (My)") +
  scale_y_continuous(name = "Age uncertainty range (My)") +
  ggtitle("Distribution of occurrences' age uncertainty range")

hist(-Cetacea_occ$age_runif, breaks = 50, col="red", probability=T, main="Distribution of occurrences, with (red) of without (blue) recent samples", xlab = "Time (My)", ylab = "Proportion of occurrences")
hist(-Cetacea_occ[Cetacea_occ$age_range<10,]$age_runif, breaks = 50, col="blue", probability=T, density=T, add=T)
```

$\to$ The removal of highly uncertain occurrences seems to be only a little biased, even if uncertainty globally increases with age.

```{r fig.height=8}
my_breaks <- c(1,3,10,35,100,max(Cetacea_occ$accepted_name_count))

ggplot(Cetacea_occ[!(Cetacea_occ$accepted_rank %in% c("species", "genus", "family")) & Cetacea_occ$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_ma, y = reorder(accepted_name, -age_mean), xend = -min_ma, yend=reorder(accepted_name, -age_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Accepted ranks") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank()) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil age ranges, by accepted rank") +
  facet_grid(accepted_rank ~ ., scales = "free")

ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_ma, y = reorder(accepted_name, -age_mean), xend = -min_ma, yend=reorder(accepted_name, -age_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Age ranges") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank(),
        axis.text.y=element_text(size=2)) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil age ranges (species)") +
  facet_grid(accepted_rank ~ ., scales = "free")

ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="genus" & Cetacea_occ$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_ma, y = reorder(accepted_name, -age_mean), xend = -min_ma, yend=reorder(accepted_name, -age_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Genus") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank(),
        axis.text.y=element_text(size=6)) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil age ranges (genera)") +
  facet_grid(accepted_rank ~ ., scales = "free")

ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="family" & Cetacea_occ$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_ma, y = reorder(accepted_name, -age_mean), xend = -min_ma, yend=reorder(accepted_name, -age_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Genus") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank()) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil age ranges (families)") +
  facet_grid(accepted_rank ~ ., scales = "free")
```

$\to$ Some species (or other ranks) have several occurrences with several time ranges, **let's combine them into a unique range covering all the others**.

## Combined time ranges = unique time range for occurrences with the same name (without the biggest ones)

```{r fig.height=8, warning=FALSE}
# Get the minimun of the minimal ages for each accepted name
Cetacea_occ$min_min_ma <- apply(Cetacea_occ, 1, function(X){min(Cetacea_occ[Cetacea_occ$accepted_name==X["accepted_name"] & Cetacea_occ$age_range<10,]$min_ma)})
# Get the maximum of the maximal ages for each accepted name
Cetacea_occ$max_max_ma <- apply(Cetacea_occ, 1, function(X){max(Cetacea_occ[Cetacea_occ$accepted_name==X["accepted_name"] & Cetacea_occ$age_range<10,]$max_ma)})
# Get the combined time interval
Cetacea_occ$age_combined_interval <- mapply(function(min_min_age, max_max_age){paste("[",-max_max_age,", ",-min_min_age,"]", sep = "")}, Cetacea_occ$min_min_ma, Cetacea_occ$max_max_ma)
# Get the combined time interval mean
Cetacea_occ$age_combined_mean <- (Cetacea_occ$min_min_ma + Cetacea_occ$max_max_ma)/2
# Get the duration of the combined time intervals
Cetacea_occ$age_combined_range <- Cetacea_occ$max_max_ma-Cetacea_occ$min_min_ma

ggplot(Cetacea_occ[!(Cetacea_occ$accepted_rank %in% c("species", "genus", "family")) & Cetacea_occ$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_max_ma, y = reorder(accepted_name, -age_combined_mean), xend = -min_min_ma, yend=reorder(accepted_name, -age_combined_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Accepted ranks") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank()) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil combined age ranges, by accepted rank") +
  facet_grid(accepted_rank ~ ., scales = "free")

ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_max_ma, y = reorder(accepted_name, -age_combined_mean), xend = -min_min_ma, yend=reorder(accepted_name, -age_combined_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Age ranges") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank(),
        axis.text.y=element_text(size=2)) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil combined age ranges (species)") +
  facet_grid(accepted_rank ~ ., scales = "free")

ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="genus" & Cetacea_occ$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_max_ma, y = reorder(accepted_name, -age_combined_mean), xend = -min_min_ma, yend=reorder(accepted_name, -age_combined_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Genera") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank(),
        axis.text.y=element_text(size=6)) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil combined age ranges (genera)") +
  facet_grid(accepted_rank ~ ., scales = "free")

ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="family" & Cetacea_occ$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_max_ma, y = reorder(accepted_name, -age_combined_mean), xend = -min_min_ma, yend=reorder(accepted_name, -age_combined_mean), color=accepted_name_count), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=1, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Families") +
  labs(colour="Accepted names count") +
  theme(panel.grid.major.y = element_blank()) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=my_breaks, labels=my_breaks) + 
  ggtitle("Distributions of fossil combined age ranges (families)") +
  facet_grid(accepted_rank ~ ., scales = "free")
```

## Occurrence density
### Density distributions

```{r fig.height=6}
# Get interval density of occurrences
Cetacea_occ$occurrence_density <- Cetacea_occ$accepted_name_count/Cetacea_occ$age_range

ggplot(Cetacea_occ[!(Cetacea_occ$accepted_rank %in% c("subspecies", "infraorder")) & Cetacea_occ$age_range<10,], aes(x=occurrence_density, fill=factor(accepted_name_count))) +
  geom_histogram(binwidth=0.1) +
  scale_x_continuous(trans="log10", name="Density of occurrences (number/My)") +
  scale_fill_discrete(name="Accepted name count") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle("Distributions occurrence density, by accepted rank") +
  facet_grid(accepted_rank ~ ., scales = "free")
```

$\to$ Density logically increases as taxa ranks increase.

## Correlation between time range and age

If we want to correct species abundance differences based on the number of occurrences in the time range ("density"), those factors should not depend on time in order to avoid penalizing periods with higher densities.

```{r}
conditions <- Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10

# Keep only one point by identical time interval

age_interval_table <- table(Cetacea_occ[conditions,]$age_interval)

interval_mean_age <- sapply(names(age_interval_table), function(x){Cetacea_occ[conditions & Cetacea_occ$age_interval==x,]$age_mean[1]})

interval_range <- sapply(names(age_interval_table), function(x){Cetacea_occ[conditions & Cetacea_occ$age_interval==x,]$age_range[1]})

df <- data.frame(x=interval_mean_age,
                 y=interval_range)

ggplot(df, aes(x=x, y=y)) + 
  geom_point(alpha=0.5) +
  geom_smooth(formula = y~x, span = 0.9, method = 'loess') +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Uncertainty range") +
  ggtitle("Smoothed correspondance between time range and age")

# Keep only one point by identical combined time interval
age_combined_interval_table <- table(Cetacea_occ[conditions,]$age_combined_interval)

combined_interval_mean_age <- sapply(names(age_combined_interval_table), function(x){Cetacea_occ[conditions & Cetacea_occ$age_combined_interval==x,]$age_combined_mean[1]})

combined_interval_range <- sapply(names(age_combined_interval_table), function(x){Cetacea_occ[conditions & Cetacea_occ$age_combined_interval==x,]$age_combined_range[1]})

combined_df <- data.frame(x=combined_interval_mean_age,
                          y=combined_interval_range)

ggplot(combined_df, aes(x=x, y=y)) + 
  geom_point(alpha=0.5) +
  geom_smooth(formula = y~x, span = 0.9, method = 'loess') + 
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Combined uncertainty range") +
  ggtitle("Smoothed correspondance between combined time range and age")
```

$\to$ It seems that age range varies importantly with time, but when taking the full combined range into account the correlation seems quite weak after the first million years.

Let's look at the density directly, because this is what is interesting us directly.

```{r}
conditions <- Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10

# Function to plot linear regression coefficients
lm_eqn <- function(df){
    m <- lm(y ~ x, df);
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

# Keep only one point by identical time interval
age_interval_table <- table(Cetacea_occ[conditions,]$age_interval)

interval_mean_age <- sapply(names(age_interval_table), function(x){Cetacea_occ[conditions & Cetacea_occ$age_interval==x,]$age_mean[1]})

interval_density <- sapply(names(age_interval_table), function(x){Cetacea_occ[conditions & Cetacea_occ$age_interval==x,]$occurrence_density[1]})

df_density <- data.frame(x=interval_mean_age,
                         y=interval_density)

ggplot(df_density, aes(x=x, y=y)) + 
  geom_point(alpha=0.5) +
  geom_smooth(formula = y~x, method=lm) + 
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Combined density") +
  ggtitle("Correlation between density and age") +
  geom_text(x = 35, y = 25, label = lm_eqn(df_density), parse = TRUE)

# Keep only one point by identical combined time interval
age_combined_interval_table <- table(Cetacea_occ[conditions,]$age_combined_interval)

combined_interval_mean_age <- sapply(names(age_combined_interval_table), function(x){Cetacea_occ[conditions & Cetacea_occ$age_combined_interval==x,]$age_combined_mean[1]})

Cetacea_occ$occurrence_combined_density <- Cetacea_occ$accepted_name_count/Cetacea_occ$age_combined_range

combined_interval_density <- sapply(names(age_combined_interval_table), function(x){Cetacea_occ[conditions & Cetacea_occ$age_combined_interval==x,]$occurrence_combined_density[1]})

combined_df_density <- data.frame(x=combined_interval_mean_age,
                                  y=combined_interval_density)

ggplot(combined_df_density, aes(x=x, y=y)) + 
  geom_point(alpha=0.5) +
  geom_smooth(formula = y~x, method=lm) + 
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Combined density") +
  ggtitle("Correlation between combined density and age") +
  geom_text(x = 15, y = 6, label = lm_eqn(combined_df_density), parse = TRUE)
```

$\to$ The density based on combined ranges is much less time-dependant than the density based on initial range ages. We will therefore use the combined density for our corrections.

## Sub-sampling of occurrences with a normalized density along the combined ranges
### Compare densities for single vs. combined ranges.

```{r fig.height=6}
conditions <- !(Cetacea_occ$accepted_rank %in% c("subspecies", "infraorder")) & Cetacea_occ$age_range<10

ggplot(Cetacea_occ[conditions,], aes(x=occurrence_density, fill=factor(accepted_name_count))) +
  geom_histogram(binwidth=0.1) +
  scale_x_continuous(trans="log10", name="Density of occurrences (number/My)") +
  scale_fill_discrete(name="Accepted name count") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle("Distributions of occurrence density, by accepted rank") +
  facet_grid(accepted_rank ~ ., scales = "free")

ggplot(Cetacea_occ[conditions,], aes(x=occurrence_combined_density, fill=factor(accepted_name_count))) +
  geom_histogram(binwidth=0.05) +
  scale_x_continuous(trans="log10", name="Combined density of occurrences (number/My)") +
  scale_fill_discrete(name="Accepted name count") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle("Distributions of combined occurrence density, by accepted rank") +
  facet_grid(accepted_rank ~ ., scales = "free")
```

$\to$ Densities are smaller and more concentrated with the combined ranges (larger time span + less ranges in total because of the collepses into unique ranges).

### Compare densities by accepted name count (species only)

Let's focus now on the occurrences accepted at the species level because they are the one for which we can correct the abundance bias by subsampling the most concentrated combined intervals.

```{r fig.height=6}
conditions <- Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10

ggplot(Cetacea_occ[conditions,], aes(x=occurrence_density, fill=factor(accepted_name_count))) +
  geom_histogram(binwidth=0.1) +
  scale_x_continuous(trans="log10", name="Density of occurrences (number/My)") +
  scale_fill_discrete(name="Accepted name count") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle("Distributions of occurrence density among species") +
  facet_grid(accepted_name_count ~ ., scales = "free")

ggplot(Cetacea_occ[conditions,], aes(x=occurrence_combined_density, fill=factor(accepted_name_count))) +
  geom_histogram(binwidth=0.05) +
  scale_x_continuous(trans="log10", name="Combined density of occurrences (number/My)") +
  scale_fill_discrete(name="Accepted name count") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle("Distributions of combined occurrence density among species") +
  facet_grid(accepted_name_count ~ ., scales = "free")
```

$\to$ Their is a huge span of densities driven by the number of occurrences for the same species that we can reduce by subsampling the most concentrated intervals.

### Impact of correcting subsampling on density distributions (species only)

```{r fig.height=6}
conditions <- Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10

ggplot(Cetacea_occ[conditions,], aes(x=occurrence_combined_density, fill=factor(accepted_name_count))) +
  geom_histogram(binwidth=0.05) +
  scale_x_continuous(trans="log10", name="Combined density of occurrences (number/My)") +
  scale_fill_discrete(name="Accepted name count") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle(paste("Distributions of combined occurrence density among species (n = ", dim(Cetacea_occ[conditions,])[1], ")", sep="")) +
  facet_grid(accepted_name_count ~ ., scales = "free")

# Add at least one occurrence of each species
Cetacea_occ_sampled <- c()
Cetacea_occ_notsampled <- c()
for (i in as.numeric(row.names(Cetacea_occ[conditions,]))){
  row <- Cetacea_occ[as.character(i),]
  if (!(row$accepted_name %in% Cetacea_occ_sampled$accepted_name)){
    Cetacea_occ_sampled <- rbind(Cetacea_occ_sampled, row)
  }else{
    Cetacea_occ_notsampled <- rbind(Cetacea_occ_notsampled, row)
  }
}

# Add occurrences in the remaning ones, by underweighting dense species
Cetacea_occ_sampled <- rbind(Cetacea_occ_sampled,
                              sample_n(Cetacea_occ_notsampled, 
                                       size=800-dim(Cetacea_occ_sampled)[1],
                                       weight=1/Cetacea_occ_notsampled$occurrence_combined_density**3))

Cetacea_occ_sampled$min_min_ma <- apply(Cetacea_occ_sampled, 1, function(X){min(Cetacea_occ_sampled[Cetacea_occ_sampled$accepted_name==X["accepted_name"],]$min_ma)})
Cetacea_occ_sampled$max_max_ma <- apply(Cetacea_occ_sampled, 1, function(X){max(Cetacea_occ_sampled[Cetacea_occ_sampled$accepted_name==X["accepted_name"],]$max_ma)})
Cetacea_occ_sampled$age_combined_range <- Cetacea_occ_sampled$max_max_ma-Cetacea_occ_sampled$min_min_ma
Cetacea_occ_sampled$accepted_name_count <- sapply(Cetacea_occ_sampled$accepted_name, function(x){table(Cetacea_occ_sampled$accepted_name)[x]})
Cetacea_occ_sampled$occurrence_combined_density <- Cetacea_occ_sampled$accepted_name_count/Cetacea_occ_sampled$age_combined_range


ggplot(Cetacea_occ_sampled, aes(x=occurrence_combined_density, fill=factor(accepted_name_count))) +
  geom_histogram(binwidth=0.05) +
  scale_x_continuous(trans="log10", name="Combined density of occurrences (number/My)", limits=c(0.1, 1000)) +
  scale_fill_discrete(name="Accepted name count") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle(paste("Distributions of combined occurrence density among species, after sampling (n = ", dim(Cetacea_occ_sampled)[1], ")", sep="")) +
  facet_grid(accepted_name_count ~ ., scales = "free")
```

$\to$ Subsampling successfully reduces the density span from 2 to 1 order of magnitude.

### Impact of subsampling on occurrences repartition (species only)

See what our distributions loook like after subsampling :

```{r fig.height=5}
breaks <- c(0.125,0.25,0.5,1,2,4,8,16)

ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_max_ma, y = reorder(accepted_name, -age_combined_mean), xend = -min_min_ma, yend=reorder(accepted_name, -age_combined_mean), color=occurrence_combined_density), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=0.5, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Species") +
  labs(colour="Occurrence\ndensity") +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid.major.y = element_blank()) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=breaks, labels=breaks) + 
  ggtitle(paste("Distributions of species fossil age ranges, before correcting sampling (n = ", dim(Cetacea_occ[Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10,])[1], ")", sep=""))

ggplot(Cetacea_occ_sampled, aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_max_ma, y = reorder(accepted_name, -age_combined_mean), xend = -min_min_ma, yend=reorder(accepted_name, -age_combined_mean), color=occurrence_combined_density), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=0.5, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Species") +
  labs(colour="Occurrence\ndensity") +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid.major.y = element_blank()) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=breaks, labels=breaks) + 
  ggtitle(paste("Distributions of species fossil age ranges, after correcting sampling (n = ", dim(Cetacea_occ_sampled)[1], ")", sep=""))
```

$\to$ Some highly dense cluster became much more similar to the others.

```{r fig.height=5}
conditions <- Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10

ggplot(Cetacea_occ[conditions,], aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="red") +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Number of occurrences") +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle(paste("Evolution of the species occurrence number through time (n = ", dim(Cetacea_occ[conditions,])[1], ")", sep=""))

ggplot(Cetacea_occ_sampled, aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="blue") +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Number of occurrences") +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.grid.major.y = element_blank()) +
  ggtitle(paste("Evolution of the species occurrence number through time, after correction sampling (n = ", dim(Cetacea_occ_sampled)[1], ")", sep=""))
```

If we superpose these 2 plots :

```{r fig.height=5}
conditions <- Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10

p1 <- ggplot(Cetacea_occ[conditions,], aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="red") +
  theme_void()

p2 <- ggplot(Cetacea_occ_sampled, aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="blue") +
  theme_void()

p1 + annotation_custom(ggplotGrob(p2))
```

$\to$ We get the new species occurrence repartition after subsampling correction, that could be used for doing inference with the occurrence birth-death model.

# New developments

## Compare with a Poisson sampling process

In order to check if the data fit our assumptions of constant-fossilisation-rate Poisson sampling we compare the observed occurrences distributions with the expected ones. Specifically, we will look at the number of taxa represented by 1, 2, 3, ... occurrences and the one that we would expect for a given distribution of combined age ranges (as a proxy for species duration).

```{r fig.height=6}
conditions <- !(Cetacea_occ$accepted_rank %in% c("subspecies", "infraorder")) & Cetacea_occ$age_range<10

ggplot(Cetacea_occ[conditions,], aes(x=age_combined_range, fill=accepted_rank)) +
  geom_histogram(binwidth = 1) + 
  #geom_point() +
  scale_x_continuous(name = "Age range (My)") +
  #scale_y_continuous(trans = "log10", name = "Count (log-scale)") +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.grid.major.x = element_blank(),
        legend.position="bottom") +
  ggtitle("Observed distributions of combined age ranges") +
  facet_grid(. ~ accepted_rank, scales = "free")

ggplot(Cetacea_occ[conditions,], aes(x=accepted_name_count, y=(table(accepted_name_count)/as.numeric(names(table(accepted_name_count))))[as.factor(accepted_name_count)], col=accepted_rank)) +
  geom_point() +
  scale_x_continuous(trans = "log10", name = "Number of occurrences by accepted name (log-scale)") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding accepted names (log-scale)") +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Observed distributions of the number of accepted names with the same number of occurrences") +
  facet_grid(accepted_rank ~ ., scales = "free")
```

In a Poisson process with occurrence sampling rate $\omega$ and for a given time interval of length $t$, the probability of observing $N_t = k$ occurrences is given by the Poisson distribution of mean of parameter $\omega\times t$ : 

$$\mathbb{P}(N_t=k) = e^{-\omega t}\frac{(\omega t)^k}{k!}$$

So in order to have the absolute probability of observing $N_0 = n$ occurrences we have to integrate over the full distribution of age ranges $t$, called $f(t)$ :

$$\mathbb{P}(N_0 = n) = \int_t P(N_t = n) f(t) dt = \int_t e^{-\omega t}\frac{(\omega t)^n}{n!} f(t) dt$$

First,  approximate this distribution :

```{r}
range_density <- approxfun(density(Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$age_combined_range[is.finite(Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$age_combined_range)]))

hist(Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$age_combined_range, probability = T, breaks = 20, main="Density approximation of the empirical range distribution", xlab = "Age range (My)")
lines(1:100/5, range_density(1:100/5))
```

Then integrate and plot the expected distribution for a given omega :

```{r}
expected_distribution <- function(n, omega, age_combined_range){
  range_density <- approxfun(density(age_combined_range[is.finite(age_combined_range)]))
  g <- function(t){dpois(n, omega*t)*range_density(t)}
  return (integrate(g, lower = 1, upper = max(age_combined_range)))
}

omega <- 0.1

dens <- sapply(0:20, function(n){expected_distribution(n, omega, Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$age_combined_range)$value})

plot(0:20, dens, main="Expected distribution of the number of accepted names with the same number of occurrences", xlab="Number of occurrences with the same accepted name", ylab = "Proportions", type = "b")
```

Finally, try to find an $\omega$ value that approximately fits the first points (the least affected by oversampling biases) and check if the other points follow the expected curve :

```{r fig.height=6}
# Recount the number of occurrences with the same accepted name after the sampling
Cetacea_occ_sampled$accepted_name_count <- sapply(Cetacea_occ_sampled$accepted_name, function(x){table(Cetacea_occ_sampled$accepted_name)[x]})

omega <- 0.1
accepted_name_count_species <- Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$accepted_name_count
dens <- sapply(1:max(accepted_name_count_species), function(n){ expected_distribution(n, omega, Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$age_combined_range)$value })
accepted_name_count_categories <- table(accepted_name_count_species)/as.numeric(names(table(accepted_name_count_species)))  # Number of categories with 1, 2, 3, ... occurrences of the same species

# Compare the initial observed distribution with the theoretical curve
ggplot(Cetacea_occ[Cetacea_occ$accepted_rank=="species",],
       aes(x=accepted_name_count, 
           y=accepted_name_count_categories[as.factor(accepted_name_count)], 
           fill=accepted_rank)) +
  geom_point() +
  
  annotate("line", x = 1:max(accepted_name_count_species), y= dens
    *max(accepted_name_count_categories[as.factor(accepted_name_count_species)]) /max(dens))+
  
  scale_x_continuous(name = "Number of occurrences by accepted name") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding accepted names (log-scale)") +
  scale_fill_discrete(name="Observed distribution") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Comparison between expected and observed distributions of number of occurrences") +
  facet_grid(accepted_rank ~ ., scales = "free")

accepted_name_count_species_sampled <- Cetacea_occ_sampled[Cetacea_occ_sampled$accepted_rank=="species",]$accepted_name_count
dens_sampled <- sapply(1:max(accepted_name_count_species_sampled), function(n){
     expected_distribution(n, omega, Cetacea_occ_sampled[Cetacea_occ_sampled$accepted_rank=="species",]$age_combined_range)$value
    })
accepted_name_count_categories_sampled <- table(accepted_name_count_species_sampled)/as.numeric(names(table(accepted_name_count_species_sampled)))  # Number of categories with 1, 2, 3, ... occurrences of the same species

# Compare the corrected observed distribution with the theoretical curve
ggplot(Cetacea_occ_sampled[Cetacea_occ_sampled$accepted_rank=="species",], 
       aes(x=accepted_name_count,
           y=accepted_name_count_categories_sampled[as.factor(accepted_name_count)],
           fill=accepted_rank)) +
  geom_point() +
  
  annotate("line", x = 1:max(accepted_name_count_species_sampled), y= dens_sampled
    *max(accepted_name_count_categories_sampled[as.factor(accepted_name_count_species_sampled)]) /max(dens_sampled)) +
  
  scale_x_continuous(name = "Number of occurrences by accepted name") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding accepted names (log-scale)") +
  scale_fill_discrete(name="Observed distribution") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Comparison between expected and observed distributions of number of occurrences, after sampling") +
  facet_grid(accepted_rank ~ ., scales = "free")
```

$\implies$ Initial observations really do not fit the expectations, **species with more than 5 occurrences must remain very rare** ! But our subsampling seems to correct most of this bias.

However, this method requires to make several arbitrary choices that may introduce new biases so we will instead subsample at other levels (palaeontological collection, geological formation). In each case only one occurrence will be sampled for the similarly identified, a process we will refer to as **aggregating** these occurrences according to the chosen factor.

## Aggregate similarly identified occurrences in each collection

```{r fig.height=6}
for (n in 5:10){
  A <- Cetacea_occ[as.logical(table(Cetacea_occ$collection_no)[Cetacea_occ$collection_no]==n),]
  A$collection_no <- droplevels(A$collection_no)

  p <- ggplot(A, aes(x=-age_mean, fill=accepted_name)) +
    geom_histogram(binwidth = 0.5, col="black") +
    scale_x_continuous(name = "Time (My)") +
    scale_y_continuous(name = "Number of occurrences in the collection") +
    theme(panel.grid.major.y = element_blank(),
          legend.position = "none") +
    ggtitle(paste("Distribution of occurrences' mean age for collections with", n, "occurrences (colored by taxa)")) +
    facet_grid(collection_no ~ ., scales="free")
  print(p)
}

A <- Cetacea_occ[as.logical(table(Cetacea_occ$collection_no)[Cetacea_occ$collection_no]>10),]
A$collection_no <- droplevels(A$collection_no)

ggplot(A, aes(x=-age_mean, fill=accepted_name)) +
  geom_histogram(binwidth = 0.5, col="black") +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Number of occurrences in the collection") +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "none") +
  ggtitle("Distribution of occurrences' mean age for collections with >10 occurrences") +
  facet_grid(collection_no ~ ., scales="free")
```

$\to$ Each collection corresponds to a unique time interval (inferred from the unique age mean).

In order to reduce the abundance bias, we may keep only one occurrence for each collection :

```{r}
Cetacea_occ_aggreg <- c()

# Browse all collections
collections <- levels(droplevels(Cetacea_occ$collection_no))
for (coll in collections){
  Cetacea_occ_coll <- Cetacea_occ[Cetacea_occ$collection_no==coll,]
  
  # Browse all accepted names in each collection & sample only 1 occurrence
  taxa <- levels(droplevels(Cetacea_occ_coll$accepted_name))
  for (name in taxa){
    Cetacea_occ_aggreg <- rbind(Cetacea_occ_aggreg, sample_n(Cetacea_occ_coll[Cetacea_occ_coll$accepted_name==name,], size = 1))
  }
}

data.frame(Cetacea_occ = c(dim(Cetacea_occ)[1],
                           dim(Cetacea_occ[Cetacea_occ$accepted_rank =="species",])[1]),
           Cetacea_occ_aggreg = c(dim(Cetacea_occ_aggreg)[1],
                                     dim(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",])[1]),
           removed = c(dim(Cetacea_occ)[1]-dim(Cetacea_occ_aggreg)[1],
                       dim(Cetacea_occ[Cetacea_occ$accepted_rank =="species",])[1]-dim(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",])[1]),
           row.names = c("Number of occurrences", "Number of occurrences (species only)"))
```

$\to$ Not enough occurrences are removed to make a sufficient difference. If we look at the collection with the highest number of occurrences :

```{r}
collection_max_occurrences <- max(table(Cetacea_occ$collection_no)[Cetacea_occ$collection_no])
collection_max_no <- names(table(Cetacea_occ$collection_no)[Cetacea_occ$collection_no][table(Cetacea_occ$collection_no)[Cetacea_occ$collection_no]==collection_max_occurrences][1])

table(droplevels(Cetacea_occ[Cetacea_occ$collection_no==collection_max_no,]$accepted_name))
```

$\to$ There are very few redundancies among the accepted names in collections so aggregating those won't reduce the abundance bias.

Instead, we may try to **aggregate occurrences with the same accepted name at the level of the geological formation** (ie subsample only one for each).

## Aggregate similarly identified occurrences in each formation

```{r fig.height=8}
Cetacea_occ_species <- Cetacea_occ[Cetacea_occ$accepted_rank=="species",]

# Browse all numbers of occurrences by formation
formation_occurrences_nb <- as.numeric(names(table(table(droplevels(Cetacea_occ_species$formation)))))

for (n in list(c(4, 7), c(8, 15), c(16, 124))){
  A <- Cetacea_occ_species[as.logical(table(Cetacea_occ_species$formation)[Cetacea_occ_species$formation]>=n[1])
                           & as.logical(table(Cetacea_occ_species$formation)[Cetacea_occ_species$formation]<=n[2]),]
  A$formation <- droplevels(A$formation)

  p <- ggplot(A, aes(x=-age_mean, fill=accepted_name)) +
    geom_histogram(binwidth = 0.5, col="black") +
    scale_x_continuous(name = "Time (My)") +
    scale_y_continuous(name = "Number of occurrences in the formation") +
    scale_fill_discrete(name="Accepted name") +
    theme(panel.grid.major.y = element_blank(),
          legend.position = "none") +
    ggtitle(paste("Distribution of occurrences' mean age for formations with", n[1], "-", n[2], "occurrences (colored by species)")) +
    facet_grid(formation ~ ., scales="free")
  print(p)
}

max_species_by_formation <- max(table(Cetacea_occ_species$formation))
A <- Cetacea_occ_species[as.logical(table(Cetacea_occ_species$formation)[Cetacea_occ_species$formation]==max_species_by_formation),]
A$formation <- droplevels(A$formation)

ggplot(A, aes(x=-age_mean, fill=reorder(accepted_name, -age_mean))) +
  geom_histogram(binwidth = 0.5, col="black") +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Number of occurrences in the formation") +
  scale_fill_discrete(name="Accepted name") +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "none") +
  ggtitle(paste("Distribution of occurrences' mean age for", max_species_by_formation, "occurrences without indicated formation (colored by species)")) +
  facet_grid(formation ~ .)
```

$\to$ For most formations each species seems to be restricted to only one age, so as expected we are not loosing too much information when aggregating them to a single occurrence.

```{r}
Cetacea_occ_aggreg <- c()

# Browse all formations
formations <- levels(droplevels(Cetacea_occ$formation))
for (form in formations){
  Cetacea_occ_form <- Cetacea_occ[Cetacea_occ$formation==form,]
  
  # Browse all accepted names in each formation & sample only 1 occurrence
  taxa <- levels(droplevels(Cetacea_occ_form$accepted_name))
  for (name in taxa){
    Cetacea_occ_aggreg <- rbind(Cetacea_occ_aggreg, sample_n(Cetacea_occ_form[Cetacea_occ_form$accepted_name==name,], size = 1))
  }
}

data.frame(Cetacea_occ = c(dim(Cetacea_occ)[1],
                           dim(Cetacea_occ[Cetacea_occ$accepted_rank =="species",])[1]),
           Cetacea_occ_aggreg = c(dim(Cetacea_occ_aggreg)[1],
                                     dim(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",])[1]),
           removed = c(dim(Cetacea_occ)[1]-dim(Cetacea_occ_aggreg)[1],
                       dim(Cetacea_occ[Cetacea_occ$accepted_rank =="species",])[1]-dim(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",])[1]),
           row.names = c("Number of occurrences", "Number of occurrences (species only)"))
```

$\to$ In that case the sub-sampling is big enough to hope correcting our bias.

```{r fig.height=7}
# Recount the number of occurrences with the same accepted name after the aggregation
Cetacea_occ_aggreg$accepted_name_count <- sapply(Cetacea_occ_aggreg$accepted_name, function(x){table(Cetacea_occ_aggreg$accepted_name)[x]})

omega <- 0.1
accepted_name_count_species <- Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$accepted_name_count
dens <- sapply(1:max(accepted_name_count_species), function(n){ expected_distribution(n, omega, Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$age_combined_range)$value })
accepted_name_count_categories <- table(accepted_name_count_species)/as.numeric(names(table(accepted_name_count_species)))  # Number of categories with 1, 2, 3, ... occurrences of the same species

# Compare the initial observed distribution with the theoretical curve
ggplot(Cetacea_occ[Cetacea_occ$accepted_rank=="species",], 
       aes(x=accepted_name_count, 
           y=accepted_name_count_categories[as.factor(accepted_name_count)], 
           fill=accepted_rank)) +
  geom_point() +
  
  annotate("line", x = 1:max(accepted_name_count_species), y= dens
    *max((table(accepted_name_count_species)/as.numeric(names(table(accepted_name_count_species))))[as.factor(accepted_name_count_species)]) /max(dens))+
  
  scale_x_continuous(name = "Number of occurrences by accepted name") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding accepted names (log-scale)") +
  scale_fill_discrete(name="Observed distribution") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Comparison between expected and observed distributions of number of occurrences") +
  facet_grid(accepted_rank ~ ., scales = "free")

accepted_name_count_species_aggreg <- Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$accepted_name_count
dens_aggreg <- sapply(1:max(accepted_name_count_species_aggreg), function(n){
     expected_distribution(n, omega, Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$age_combined_range)$value
    })
accepted_name_count_categories_aggreg <- table(accepted_name_count_species_aggreg)/as.numeric(names(table(accepted_name_count_species_aggreg)))  # Number of categories with 1, 2, 3, ... occurrences of the same species

# Compare the corrected observed distribution with the theoretical curve
ggplot(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",], 
       aes(x=accepted_name_count,
           y=accepted_name_count_categories_aggreg[as.factor(accepted_name_count)], 
           fill=accepted_rank)) +
  geom_point() +
  
  annotate("line", x = 1:max(accepted_name_count_species_aggreg), y= dens_aggreg
    *max((table(accepted_name_count_species_aggreg)/as.numeric(names(table(accepted_name_count_species_aggreg))))[as.factor(accepted_name_count_species_aggreg)]) /max(dens_aggreg)) +
  
  scale_x_continuous(name = "Number of occurrences by accepted name") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding accepted names (log-scale)") +
  scale_fill_discrete(name="Observed distribution") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Comparison between expected and observed distributions of number of occurrences, after aggregating in formations") +
  facet_grid(accepted_rank ~ ., scales = "free")

accepted_name_count_species_aggreg <- Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$accepted_name_count
dens_aggreg <- sapply(1:max(accepted_name_count_species_aggreg), function(n){
     expected_distribution(n, omega, Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$age_combined_range)$value
    })
accepted_name_count_categories_aggreg <- table(accepted_name_count_species_aggreg)/as.numeric(names(table(accepted_name_count_species_aggreg)))  # Number of categories with 1, 2, 3, ... occurrences of the same species
```

$\to$ The bias can be corridered as completely corrected.

```{r fig.height=6}
conditions <- Cetacea_occ$accepted_rank =="species"

p1 <- ggplot(Cetacea_occ[conditions,], aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill=NA, col="red") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 70) +
  theme_void()

p2 <- ggplot(Cetacea_occ_sampled, aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="blue") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 70) +
  theme_void()

p3 <- ggplot(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",], aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="green") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 70) +
  theme_void()

p1 + annotation_custom(ggplotGrob(p2)) + ggtitle("Initial occurrences distribution (red) and comparison after sub-sampling (blue)")

p1 + annotation_custom(ggplotGrob(p3)) + ggtitle("Initial occurrences distribution (red) and comparison after aggregating in formations (green)")

p1 + annotation_custom(ggplotGrob(p2)) + annotation_custom(ggplotGrob(p3)) + ggtitle("Initial occurrences distribution (red) and comparison after sub-sampling (blue) or aggregating in formations (green)")
```

$\to$ Comparing with the initial occurrences distribution and with the distribution after our first sub-sampling it appears that both methods lead to very similar distributions. This conforts us about the robustness of those approaches.

However, we have to take into account the occurrences that do not have any indicated geological formation to subsample them separately. To approximate geological formation we chose to proceed to the aggregation based on the combination of the country and the early stratigraphic interval.

## Aggregate occurrences without formation by country + early interval

```{r}
Cetacea_occ_aggreg <- c()

# Browse all countries
countries <- levels(droplevels(Cetacea_occ[Cetacea_occ$formation=="",]$cc))
for (country in countries){
  Cetacea_occ_cc <- Cetacea_occ[Cetacea_occ$formation=="" & Cetacea_occ$cc==country,]
  
  # Browse all early stratigraphic intervals
  early_intervals <- levels(droplevels(Cetacea_occ_cc$early_interval))
  for (ei in early_intervals){
    Cetacea_occ_cc_ei <- Cetacea_occ_cc[Cetacea_occ_cc$early_interval==ei,]
    
    # Browse all accepted names in each country & sample only 1 occurrence
    taxa <- levels(droplevels(Cetacea_occ_cc_ei$accepted_name))
    for (name in taxa){
      Cetacea_occ_aggreg <- rbind(Cetacea_occ_aggreg,
                                     sample_n(Cetacea_occ_cc_ei[Cetacea_occ_cc_ei$accepted_name==name,], size = 1))
    }
  }
}

# Browse all formations
formations <- levels(droplevels(Cetacea_occ$formation))
for (form in formations[-which(formations=="")]){
  Cetacea_occ_form <- Cetacea_occ[Cetacea_occ$formation==form,]
  
  # Browse all accepted names in each formation & sample only 1 occurrence
  taxa <- levels(droplevels(Cetacea_occ_form$accepted_name))
  for (name in taxa){
    Cetacea_occ_aggreg <- rbind(Cetacea_occ_aggreg, sample_n(Cetacea_occ_form[Cetacea_occ_form$accepted_name==name,], size = 1))
  }
}

data.frame(Cetacea_occ = c(dim(Cetacea_occ)[1],
                           dim(Cetacea_occ[Cetacea_occ$accepted_rank =="species",])[1]),
           Cetacea_occ_aggreg = c(dim(Cetacea_occ_aggreg)[1],
                                     dim(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",])[1]),
           removed = c(dim(Cetacea_occ)[1]-dim(Cetacea_occ_aggreg)[1],
                       dim(Cetacea_occ[Cetacea_occ$accepted_rank =="species",])[1]-dim(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",])[1]),
           row.names = c("Number of occurrences", "Number of occurrences (species only)"))
```

More occurrences remain after aggregating with this new method. Let's compare again with the theoretical distribution :

```{r fig.height=7}
# Recount the number of occurrences with the same accepted name after the aggregation
Cetacea_occ_aggreg$accepted_name_count <- sapply(Cetacea_occ_aggreg$accepted_name, function(x){table(Cetacea_occ_aggreg$accepted_name)[x]})

omega <- 0.15
accepted_name_count_species <- Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$accepted_name_count
dens <- sapply(1:max(accepted_name_count_species), function(n){ expected_distribution(n, omega, Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$age_combined_range)$value })
accepted_name_count_categories <- table(accepted_name_count_species)/as.numeric(names(table(accepted_name_count_species)))  # Number of categories with 1, 2, 3, ... occurrences of the same species

# Compare the initial observed distribution with the theoretical curve
ggplot(Cetacea_occ[Cetacea_occ$accepted_rank=="species",], 
       aes(x=accepted_name_count, 
           y=accepted_name_count_categories[as.factor(accepted_name_count)], 
           fill=accepted_rank)) +
  geom_point() +
  
  annotate("line", x = 1:max(accepted_name_count_species), y= dens
    *max((table(accepted_name_count_species)/as.numeric(names(table(accepted_name_count_species))))[as.factor(accepted_name_count_species)]) /max(dens))+
  
  scale_x_continuous(name = "Number of occurrences by accepted name") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding accepted names (log-scale)") +
  scale_fill_discrete(name="Observed distribution") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Comparison between expected and observed distributions of number of occurrences") +
  facet_grid(accepted_rank ~ ., scales = "free")

accepted_name_count_species_aggreg <- Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$accepted_name_count
dens_aggreg <- sapply(1:max(accepted_name_count_species_aggreg), function(n){
     expected_distribution(n, omega, Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$age_combined_range)$value
    })
accepted_name_count_categories_aggreg <- table(accepted_name_count_species_aggreg)/as.numeric(names(table(accepted_name_count_species_aggreg)))  # Number of categories with 1, 2, 3, ... occurrences of the same species

# Compare the corrected observed distribution with the theoretical curve
ggplot(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",], 
       aes(x=accepted_name_count,
           y=accepted_name_count_categories_aggreg[as.factor(accepted_name_count)], 
           fill=accepted_rank)) +
  geom_point() +
  
  annotate("line", x = 1:max(accepted_name_count_species_aggreg), y= dens_aggreg
    *max((table(accepted_name_count_species_aggreg)/as.numeric(names(table(accepted_name_count_species_aggreg))))[as.factor(accepted_name_count_species_aggreg)]) /max(dens_aggreg)) +
  
  scale_x_continuous(name = "Number of occurrences by accepted name") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding accepted names (log-scale)") +
  scale_fill_discrete(name="Observed distribution") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Comparison between expected and observed distributions of number of occurrences, after aggregating in formations") +
  facet_grid(accepted_rank ~ ., scales = "free")

accepted_name_count_species_aggreg <- Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$accepted_name_count
dens_aggreg <- sapply(1:max(accepted_name_count_species_aggreg), function(n){
     expected_distribution(n, omega, Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$age_combined_range)$value
    })
accepted_name_count_categories_aggreg <- table(accepted_name_count_species_aggreg)/as.numeric(names(table(accepted_name_count_species_aggreg)))  # Number of categories with 1, 2, 3, ... occurrences of the same species
```

$\to$ The correspondance is still good, except for two taxa :

```{r}
table(droplevels(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",][accepted_name_count_species_aggreg>10,]$accepted_name))
```

```{r, warning=FALSE}
Cetacea_occ_aggreg$age_range <- Cetacea_occ_aggreg$max_ma-Cetacea_occ_aggreg$min_ma
Cetacea_occ_aggreg$min_min_ma <- apply(Cetacea_occ_aggreg, 1, function(X){min(Cetacea_occ_aggreg[Cetacea_occ_aggreg$age_range<10 & Cetacea_occ_aggreg$accepted_name==X["accepted_name"],]$min_ma)})
Cetacea_occ_aggreg$max_max_ma <- apply(Cetacea_occ_aggreg, 1, function(X){max(Cetacea_occ_aggreg[Cetacea_occ_aggreg$age_range<10 & Cetacea_occ_aggreg$accepted_name==X["accepted_name"],]$max_ma)})
Cetacea_occ_aggreg$age_combined_mean <- (Cetacea_occ_aggreg$min_min_ma + Cetacea_occ_aggreg$max_max_ma)/2
Cetacea_occ_aggreg$age_combined_range <- Cetacea_occ_aggreg$max_max_ma-Cetacea_occ_aggreg$min_min_ma
Cetacea_occ_aggreg$accepted_name_count <- sapply(Cetacea_occ_aggreg$accepted_name, function(x){table(Cetacea_occ_aggreg$accepted_name)[x]})
Cetacea_occ_aggreg$occurrence_combined_density <- Cetacea_occ_aggreg$accepted_name_count/Cetacea_occ_aggreg$age_combined_range
```

```{r fig.height=5, message=FALSE}
breaks <- c(0.125,0.25,0.5,1,2,4,8,16)

p_before <- ggplot(Cetacea_occ[Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_max_ma, y = reorder(accepted_name, -age_combined_mean), xend = -min_min_ma, yend=reorder(accepted_name, -age_combined_mean), color=occurrence_combined_density), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=0.5, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Species") +
  labs(colour="Occurrence\ndensity") +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid.major.y = element_blank(),
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill = "transparent", color = NA),
        legend.box.background = element_rect(fill = "transparent", color = NA)) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=breaks, labels=breaks) + 
  ggtitle(paste("Distributions of species fossil age ranges, before correcting sampling (n = ", dim(Cetacea_occ[Cetacea_occ$accepted_rank =="species" & Cetacea_occ$age_range<10,])[1], ")", sep=""))
p_before

ggsave("Images/Range_distributions_before_aggregating.svg", plot = p_before, device = "svg", bg = "transparent")

p_after <- ggplot(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species" & Cetacea_occ_aggreg$age_range<10,], aes(x=-max_ma, y=accepted_name)) +
  geom_segment(aes(x = -max_max_ma, y = reorder(accepted_name, -age_combined_mean), xend = -min_min_ma, yend=reorder(accepted_name, -age_combined_mean), color=occurrence_combined_density), arrow=arrow(ends = "both", angle=90, length = unit(1, "mm")), alpha=0.5) +
  geom_point(aes(x=-age_runif), col="red", cex=0.5, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_discrete(name = "Species") +
  labs(colour="Occurrence\ndensity") +
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid.major.y = element_blank(),
        plot.background = element_rect(fill = "transparent", color = NA),
        legend.background = element_rect(fill = "transparent", color = NA),
        legend.box.background = element_rect(fill = "transparent", color = NA)) +
  scale_color_gradientn(colours = c("darkblue", "forestgreen", "black"), trans="log", breaks=breaks, labels=breaks) + 
  ggtitle(paste("Distributions of species fossil age ranges, after correcting sampling (n = ", dim(Cetacea_occ_sampled)[1], ")", sep=""))
p_after

ggsave("Images/Range_distributions_after_aggregating.svg", plot = p_after, device = "svg", bg = "transparent")
```

```{r fig.height=6, message=FALSE}
conditions <- Cetacea_occ$accepted_rank =="species"

p1 <- ggplot(Cetacea_occ[conditions,], aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill=NA, col="red") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 70) +
  theme_void()

p2 <- ggplot(Cetacea_occ_sampled, aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="blue") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 70) +
  theme_void()

p3 <- ggplot(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",], aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="green") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 70) +
  theme_void()

p1 + annotation_custom(ggplotGrob(p2)) + ggtitle("Initial occurrences distribution (red) and comparison after sub-sampling (blue)")

p1 + annotation_custom(ggplotGrob(p3)) + ggtitle("Initial occurrences distribution (red) and comparison after aggregating in formations (green)")

p_all <- p1 + annotation_custom(ggplotGrob(p2)) + annotation_custom(ggplotGrob(p3)) + ggtitle("Initial occurrences distribution (red) and comparison after sub-sampling (blue) or aggregating in formations (green)") + theme(plot.background = element_rect(fill = "transparent", color = NA))
p_all

ggsave("Images/Occurrence_distributions_comparison.svg", plot = p_all, device = "svg", bg = "transparent")
```

$\to$ Comparing with the initial occurrences distribution and with the distribution after our first sub-sampling it appears that both methods lead to very similar distributions. This conforts us about the robustness of those approaches.

Replacing coutries by gelogical plates seems to make more sens from a palaeontological perspective, so let's try it.

## Aggregate occurrences without formation by geoplate + early interval

```{r}
Cetacea_occ_aggreg <- c()

# Browse all geoplates
geoplates <- levels(droplevels(Cetacea_occ[Cetacea_occ$formation=="",]$geoplate))
for (gp in geoplates){
  Cetacea_occ_gp <- Cetacea_occ[Cetacea_occ$formation=="" & Cetacea_occ$geoplate==gp,]
  
  # Browse all early stratigraphic intervals
  early_intervals <- levels(droplevels(Cetacea_occ_gp$early_interval))
  for (ei in early_intervals){
    Cetacea_occ_gp_ei <- Cetacea_occ_gp[Cetacea_occ_gp$early_interval==ei,]
    
    # Browse all accepted names & sample only 1 occurrence
    taxa <- levels(droplevels(Cetacea_occ_gp_ei$accepted_name))
    for (name in taxa){
      Cetacea_occ_aggreg <- rbind(Cetacea_occ_aggreg,
                                     sample_n(Cetacea_occ_gp_ei[Cetacea_occ_gp_ei$accepted_name==name,], size = 1))
    }
  }
}

# Browse all formations
formations <- levels(droplevels(Cetacea_occ$formation))
for (form in formations[-which(formations=="")]){
  Cetacea_occ_form <- Cetacea_occ[Cetacea_occ$formation==form,]
  
  # Browse all accepted names in each formation & sample only 1 occurrence
  taxa <- levels(droplevels(Cetacea_occ_form$accepted_name))
  for (name in taxa){
    Cetacea_occ_aggreg <- rbind(Cetacea_occ_aggreg, sample_n(Cetacea_occ_form[Cetacea_occ_form$accepted_name==name,], size = 1))
  }
}

data.frame(Cetacea_occ = c(dim(Cetacea_occ)[1],
                           dim(Cetacea_occ[Cetacea_occ$accepted_rank =="species",])[1]),
           Cetacea_occ_aggreg = c(dim(Cetacea_occ_aggreg)[1],
                                     dim(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",])[1]),
           removed = c(dim(Cetacea_occ)[1]-dim(Cetacea_occ_aggreg)[1],
                       dim(Cetacea_occ[Cetacea_occ$accepted_rank =="species",])[1]-dim(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",])[1]),
           row.names = c("Number of occurrences", "Number of occurrences (species only)"))
```

More occurrences remain after aggregating with this new method. Let's compare again with the theoretical distribution :

```{r fig.height=7}
# Recount the number of occurrences with the same accepted name after the aggregation
Cetacea_occ_aggreg$accepted_name_count <- sapply(Cetacea_occ_aggreg$accepted_name, function(x){table(Cetacea_occ_aggreg$accepted_name)[x]})

omega <- 0.15
accepted_name_count_species <- Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$accepted_name_count
dens <- sapply(1:max(accepted_name_count_species), function(n){ expected_distribution(n, omega, Cetacea_occ[Cetacea_occ$accepted_rank=="species",]$age_combined_range)$value })
accepted_name_count_categories <- table(accepted_name_count_species)/as.numeric(names(table(accepted_name_count_species)))  # Number of categories with 1, 2, 3, ... occurrences of the same species

# Compare the initial observed distribution with the theoretical curve
ggplot(Cetacea_occ[Cetacea_occ$accepted_rank=="species",], 
       aes(x=accepted_name_count, 
           y=accepted_name_count_categories[as.factor(accepted_name_count)], 
           fill=accepted_rank)) +
  geom_point() +
  
  annotate("line", x = 1:max(accepted_name_count_species), y= dens
    *max((table(accepted_name_count_species)/as.numeric(names(table(accepted_name_count_species))))[as.factor(accepted_name_count_species)]) /max(dens))+
  
  scale_x_continuous(name = "Number of occurrences by accepted name") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding accepted names (log-scale)") +
  scale_fill_discrete(name="Observed distribution") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Comparison between expected and observed distributions of number of occurrences") +
  facet_grid(accepted_rank ~ ., scales = "free")

accepted_name_count_species_aggreg <- Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$accepted_name_count
dens_aggreg <- sapply(1:max(accepted_name_count_species_aggreg), function(n){
     expected_distribution(n, omega, Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$age_combined_range)$value
    })
accepted_name_count_categories_aggreg <- table(accepted_name_count_species_aggreg)/as.numeric(names(table(accepted_name_count_species_aggreg)))  # Number of categories with 1, 2, 3, ... occurrences of the same species

# Compare the corrected observed distribution with the theoretical curve
ggplot(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",], 
       aes(x=accepted_name_count,
           y=accepted_name_count_categories_aggreg[as.factor(accepted_name_count)], 
           fill=accepted_rank)) +
  geom_point() +
  
  annotate("line", x = 1:max(accepted_name_count_species_aggreg), y= dens_aggreg
    *max((table(accepted_name_count_species_aggreg)/as.numeric(names(table(accepted_name_count_species_aggreg))))[as.factor(accepted_name_count_species_aggreg)]) /max(dens_aggreg)) +
  
  scale_x_continuous(name = "Number of occurrences by accepted name") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding accepted names (log-scale)") +
  scale_fill_discrete(name="Observed distribution") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Comparison between expected and observed distributions of number of occurrences, after aggregating in geoplates") +
  facet_grid(accepted_rank ~ ., scales = "free")

accepted_name_count_species_aggreg <- Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$accepted_name_count
dens_aggreg <- sapply(1:max(accepted_name_count_species_aggreg), function(n){
     expected_distribution(n, omega, Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]$age_combined_range)$value
    })
accepted_name_count_categories_aggreg <- table(accepted_name_count_species_aggreg)/as.numeric(names(table(accepted_name_count_species_aggreg)))  # Number of categories with 1, 2, 3, ... occurrences of the same species
```

$\to$ The correspondance is still good, except for two taxa :

```{r}
table(droplevels(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",][accepted_name_count_species_aggreg>10,]$accepted_name))
```

```{r fig.height=6}
conditions <- Cetacea_occ$accepted_rank =="species"

p1 <- ggplot(Cetacea_occ[conditions,], aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill=NA, col="red") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 70) +
  theme_void()

p2 <- ggplot(Cetacea_occ_sampled, aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="blue") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 70) +
  theme_void()

p3 <- ggplot(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",], aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="green") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 70) +
  theme_void()

p1 + annotation_custom(ggplotGrob(p2)) + ggtitle("Initial occurrences distribution (red) and comparison after sub-sampling (blue)")

p1 + annotation_custom(ggplotGrob(p3)) + ggtitle("Initial occurrences distribution (red) and comparison after aggregating in geoplates (green)")

p1 + annotation_custom(ggplotGrob(p2)) + annotation_custom(ggplotGrob(p3)) + ggtitle("Initial occurrences distribution (red) and comparison after sub-sampling (blue) or aggregating in geoplates (green)")
```

$\to$ Delimiting by geological plates (+ age) instead of countries (+ age) leads to similar distributions, so we will keep it.

## Check that the sampling methods do not introduce biases in the repartition between Odontoceti and Mysticeti

Mystecetes are usually larger than odontocetes, and size is associated with a wider geographic range so since we are subsampling occurrences according to geological formation we may be biasing our data towards more widespread species, therefore towards mystecetes.

Look at the families first :

```{r fig.height=6}
families <- rbind(Cetacea_occ = Cetacea_occ[Cetacea_occ$accepted_rank=="species",],
                  Cetacea_occ_sampled = Cetacea_occ_sampled,
                  Cetacea_occ_aggreg = Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank=="species",]) %>%
            tibble::rownames_to_column(var = "Dataset")

families <- families[,c("Dataset", "family")]
families$Dataset <- sapply(families$Dataset, gsub, pattern="\\..*", replacement="")

ggplot(families[families$family != "NO_FAMILY_SPECIFIED",], aes(x = Dataset, fill = family)) + 
    geom_bar(position="fill", col="black")
```

$\to$ The family repartitions vary a bit after subsampling, but because of the limited number of species by family the fact that we corrected the oversampling of some species could have a disproportionate effect.

Let's look rather at a higher taxonomic rank, by importing the topology of cetacean families (from Marx et al. 2016) :

```{r fig.width=10}
families_tree <- ape::read.tree("bjoelle-stratigraphic_age_uncertainty_SI-9bbcef2/cetaceans_data/fossils/families.tre")
ggtree(families_tree) +
  geom_tiplab() +
  geom_nodelab() + 
  ggtitle("Topology of cetacean families") +
  xlim(0, 8)

families_tree_Odontoceti <- castor::get_subtree_at_node(families_tree, "Odontoceti")$subtree
ggtree(families_tree_Odontoceti) +
  geom_tiplab() +
  geom_nodelab() + 
  ggtitle("Topology of odontocete families") +
  xlim(0, 5)

families_tree_Mysticeti <- castor::get_subtree_at_node(families_tree, "Mysticeti")$subtree
ggtree(families_tree_Mysticeti) +
  geom_tiplab() +
  geom_nodelab() + 
  ggtitle("Topology of mysticete families") +
  xlim(0, 5)

families_tree_Stem <- castor::get_subtree_with_tips(families_tree, omit_tips = c(families_tree_Odontoceti$tip.label, families_tree_Mysticeti$tip.label))$subtree
ggtree(families_tree_Stem) +
  geom_tiplab() +
  geom_nodelab() + 
  ggtitle("Topology of archeocete families") +
  xlim(0, 3)
```

```{r}
Odontoceti_families <- c(families_tree_Odontoceti[c("tip.label", "node.label")], "Kentriodontidae", "Squaloziphiidae")
Mysticeti_families <- families_tree_Mysticeti[c("tip.label", "node.label")]
archaeocete_families <- families_tree_Stem[c("tip.label", "node.label")]

family_to_taxonomic_group <- function(family){
  return(c("Odontoceti", "Mysticeti", "archaeocetes")[
    grep(pattern = family,
         x = list(Odontoceti_families, Mysticeti_families, archaeocete_families))])
  }

families$Taxonomic.group <- as.character(sapply(families$family, family_to_taxonomic_group))
ggplot(families[families$family != "NO_FAMILY_SPECIFIED",], aes(x = Dataset, fill = Taxonomic.group)) + 
    geom_bar(position="fill", col="black")

ggplot(families[families$family != "NO_FAMILY_SPECIFIED" & families$Taxonomic.group != "archaeocetes",], aes(x = Dataset, fill = Taxonomic.group)) +
  geom_bar(position="fill", col="black")
```

$\to$ There is a smaller proportion of archeocete occurrences after either sampling, because a huge cluster is subsampled around 35 My ago, but this effect is expected. However, for the Mysticeti vs. Odotoceti there is no huge apparent bias, especially with the aggregating method.

```{r}
# write(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",]$age_runif, 
#       file = "data-cetaceans/Cetacea_age_runif_age_species_corrected.csv", 
#       sep = "; ", 
#       ncolumns = dim(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank =="species",])[1])
write.table(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank == "species", c("min_ma", "max_ma")],
            file="data-cetaceans/Cetacea_occurrences_min_max_age_species_corrected.csv", sep=",", row.names=FALSE, col.names=FALSE)

write.table(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank %in% c("species", "genus"), c("min_ma", "max_ma")],
            file="data-cetaceans/Cetacea_occurrences_min_max_age_species_genera_corrected.csv", sep=",", row.names=FALSE, col.names=FALSE)
```

```{r}
ggplot(Cetacea_occ_aggreg[Cetacea_occ_aggreg$accepted_rank == "species",], aes(x=-age_runif, y=rnorm(length(age_runif), 1, 0.03))) +
  geom_point(cex=1.5, alpha=0.5) +
  scale_x_continuous(name = "Time (My)") +
  scale_y_continuous(name = "Occurrences", limits = c(0.5, 1.5)) +
  scale_fill_discrete(name="Accepted rank") +
  theme(panel.background = element_blank(),
        axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  ggtitle(paste("Repartition of", dim(cetacea_pbdb)[1], "recorded occurrences through time"))
```

# Faster genus-level analysis

```{r}
Cetacea_occ_aggreg_gen <- c()

# Browse all formations
formations <- levels(droplevels(Cetacea_occ$formation))
for (form in formations[-which(formations=="")]){
  Cetacea_occ_form <- Cetacea_occ[Cetacea_occ$formation==form,]
  
  # Browse all genera in each formation & sample only 1 occurrence
  genera <- levels(droplevels(Cetacea_occ_form$genus))
  for (gen in genera){
    Cetacea_occ_aggreg_gen <- rbind(Cetacea_occ_aggreg_gen, sample_n(Cetacea_occ_form[Cetacea_occ_form$genus==gen,], size = 1))
  }
}

# Browse all geoplates
geoplates <- levels(droplevels(Cetacea_occ[Cetacea_occ$formation=="",]$geoplate))
for (gp in geoplates){
  Cetacea_occ_gp <- Cetacea_occ[Cetacea_occ$formation=="" & Cetacea_occ$geoplate==gp,]
  
  # Browse all early stratigraphic intervals
  early_intervals <- levels(droplevels(Cetacea_occ_gp$early_interval))
  for (ei in early_intervals){
    Cetacea_occ_gp_ei <- Cetacea_occ_gp[Cetacea_occ_gp$early_interval==ei,]
    
    # Browse all genera & sample only 1 occurrence
    genera <- levels(droplevels(Cetacea_occ_gp_ei$genus))
    for (gen in genera){
      Cetacea_occ_aggreg_gen <- rbind(Cetacea_occ_aggreg_gen,
                                     sample_n(Cetacea_occ_gp_ei[Cetacea_occ_gp_ei$genus==gen,], size = 1))
    }
  }
}

data.frame(Cetacea_occ = c(dim(Cetacea_occ)[1], 
                           dim(Cetacea_occ[Cetacea_occ$accepted_rank %in% c("species", "genus"),])[1]),
           Cetacea_occ_aggreg_gen = c(dim(Cetacea_occ_aggreg_gen)[1],
                                  dim(Cetacea_occ_aggreg_gen[Cetacea_occ_aggreg_gen$accepted_rank %in% c("species", "genus"),])[1]),
           removed = c(dim(Cetacea_occ)[1]-dim(Cetacea_occ_aggreg_gen)[1],
                       dim(Cetacea_occ[Cetacea_occ$accepted_rank %in% c("species", "genus"),])[1]-dim(Cetacea_occ_aggreg_gen[Cetacea_occ_aggreg_gen$accepted_rank %in% c("species", "genus"),])[1]),
           row.names = c("Number of occurrences", "Number of occurrences (species and genera only)"))
```

More occurrences remain after aggregating with this new method. Let's compare again with the theoretical distribution :

```{r fig.height=7}
# Recount the number of occurrences with the same genus after the aggregation
Cetacea_occ$genus_count <- sapply(Cetacea_occ$genus, function(x){table(Cetacea_occ$genus)[x]})
Cetacea_occ_aggreg_gen$genus_count <- sapply(Cetacea_occ_aggreg_gen$genus, function(x){table(Cetacea_occ_aggreg_gen$genus)[x]})

omega <- 0.3
genus_count <- Cetacea_occ[Cetacea_occ$accepted_rank %in% c("species", "genus"),]$genus_count
dens <- sapply(1:max(genus_count), function(n){ expected_distribution(n, omega, Cetacea_occ[Cetacea_occ$accepted_rank %in% c("species", "genus"),]$age_combined_range)$value })
genus_count_categories <- table(genus_count)/as.numeric(names(table(genus_count)))  # Number of categories with 1, 2, 3, ... occurrences of the same genus

# Compare the initial observed distribution with the theoretical curve
ggplot(Cetacea_occ[Cetacea_occ$accepted_rank %in% c("species", "genus"),], 
       aes(x=genus_count, 
           y=genus_count_categories[as.factor(genus_count)], 
           fill=accepted_rank)) +
  geom_point() +
  
  annotate("line", x = 1:max(genus_count), y= dens
    *max((table(genus_count)/as.numeric(names(table(genus_count))))[as.factor(genus_count)]) /max(dens))+
  
  scale_x_continuous(name = "Number of occurrences by genus") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding genera (log-scale)") +
  scale_fill_discrete(name="Observed distribution") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Comparison between expected and observed distributions of number of occurrences")

genus_count_aggreg <- Cetacea_occ_aggreg_gen[Cetacea_occ_aggreg_gen$accepted_rank %in% c("species", "genus"),]$genus_count
dens_aggreg <- sapply(1:max(genus_count_aggreg), function(n){
     expected_distribution(n, omega, Cetacea_occ_aggreg_gen[Cetacea_occ_aggreg_gen$accepted_rank %in% c("species", "genus"),]$age_combined_range)$value
    })

# Number of categories with 1, 2, 3, ... occurrences of the same genus
genus_count_categories_aggreg <- table(genus_count_aggreg)/as.numeric(names(table(genus_count_aggreg)))

# Number of occurrences by category
Cetacea_occ_aggreg_gen$genus_categories_count <- as.numeric(genus_count_categories_aggreg[as.factor(Cetacea_occ_aggreg_gen$genus_count)])

# Compare the corrected observed distribution with the theoretical curve
ggplot(Cetacea_occ_aggreg_gen[Cetacea_occ_aggreg_gen$accepted_rank %in% c("species", "genus"),], 
       aes(x=genus_count,
           y=genus_categories_count,
           size=genus_categories_count)) +
  geom_point() +
  
  annotate("line", x = 1:max(genus_count_aggreg), y= dens_aggreg
    *max((table(genus_count_aggreg)/as.numeric(names(table(genus_count_aggreg))))[as.factor(genus_count_aggreg)]) /max(dens_aggreg)) +
  
  scale_x_continuous(name = "Number of occurrences by genus") +
  scale_y_continuous(trans = "log10", name = "Number of corresponding genera (log-scale)") +
  scale_fill_discrete(name="Observed distribution") +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_blank()) +
  ggtitle("Comparison between expected and observed distributions of number of occurrences, after aggregating in geoplates")

genus_count_aggreg <- Cetacea_occ_aggreg_gen[Cetacea_occ_aggreg_gen$accepted_rank %in% c("species", "genus"),]$genus_count
dens_aggreg <- sapply(1:max(genus_count_aggreg), function(n){
     expected_distribution(n, omega, Cetacea_occ_aggreg_gen[Cetacea_occ_aggreg_gen$accepted_rank %in% c("species", "genus"),]$age_combined_range)$value
    })
genus_count_categories_aggreg <- table(genus_count_aggreg)/as.numeric(names(table(genus_count_aggreg)))  # Number of categories with 1, 2, 3, ... occurrences of the same genus
```

$\to$ The correspondance is much less improved than with species aggregation because some genera have a lot of occurrences due to their high number of species species :

```{r}
table(droplevels(Cetacea_occ_aggreg_gen[(Cetacea_occ_aggreg_gen$accepted_rank %in% c("species", "genus")) & (Cetacea_occ_aggreg_gen$genus_count>25),]$genus))
```

```{r fig.height=6}
conditions <- Cetacea_occ$accepted_rank %in% c("species", "genus")

p1 <- ggplot(Cetacea_occ[conditions,], aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill=NA, col="red") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 100) +
  theme_void()

p2 <- ggplot(Cetacea_occ_sampled, aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="blue") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 100) +
  theme_void()

p3 <- ggplot(Cetacea_occ_aggreg_gen[Cetacea_occ_aggreg_gen$accepted_rank %in% c("species", "genus"),], aes(x=-age_runif)) +
  geom_histogram(binwidth = 0.5, alpha=0.5, fill="green") +
  xlim(-max(Cetacea_occ[conditions,]$age_runif)-1, 1) +
  ylim(0, 100) +
  theme_void()

p1 + annotation_custom(ggplotGrob(p2)) + ggtitle("Initial occurrences distribution (red) and comparison after sub-sampling (blue)")

p1 + annotation_custom(ggplotGrob(p3)) + ggtitle("Initial occurrences distribution (red) and comparison after aggregating in geoplates (green)")

p1 + annotation_custom(ggplotGrob(p2)) + annotation_custom(ggplotGrob(p3)) + ggtitle("Initial occurrences distribution (red) and comparison after sub-sampling (blue) or aggregating in geoplates (green)")
```

$\to$ Delimiting by geological plates (+ age) instead of countries (+ age) leads to similar distributions, with a bit more occurrences, so we will keep it.

```{r}
write.table(Cetacea_occ_aggreg_gen[Cetacea_occ_aggreg_gen$accepted_rank %in% c("species", "genus"), c("min_ma", "max_ma")],
            file="data-cetaceans/Cetacea_occurrences_min_max_age_genera_corrected.csv", sep=",", row.names=FALSE, col.names=FALSE)
```

# Conclusions

Achievements :

  - It seems possible to adequately reduce the abundance bias by subsampling the most concentrated intervals $\to$ **species only**
  - Using combined ranges by species appears to be more robust $\to$ **to be confirmed**
  - Very recent samples may have been dated with a more precise method and contain much more fossils, so they should be removed or treated separatadely $\to$ **additional information needed**

Open questions :

  - What about other accepted ranks ?
    1. The problem is that differences in the number of occurrences at higher ranks could be due to differences in individual abundances inside species or due to differences in the number of species inside that group.
    2. A solution could be to look at the number of species by group based on the indicated species, and include it in the bias correction : homogeneizing the *number of occurrences / time unit / number sf species in the group* $\to$ **additional data required** (ranks classification)
  - Why do most occurrences miss a late stratigraphic limit ?
  - Some occurrences have very huge time intervals $\to$ **Was is a good idea to remove those >10My ? Should we remove more of them (>5My) ?**


    
    